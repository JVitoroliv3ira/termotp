name: Build and Release

on:
  push:
    tags:
      - 'v*' 

jobs:
  build:
    name: Build Binaries
    runs-on: ubuntu-latest

    strategy:
      matrix:
        os: [linux, windows]
        arch: [amd64]

    steps:
      - name: Checkout c√≥digo-fonte
        uses: actions/checkout@v4

      - name: Configurar Go
        uses: actions/setup-go@v4
        with:
          go-version: 1.24
          check-latest: true

      - name: Verificar vers√£o do Go e depend√™ncias
        run: |
          go version
          go env
          go mod tidy

      - name: Obter vers√£o do Git Tag
        id: get_version
        run: echo "VERSION=$(git describe --tags --always)" >> $GITHUB_ENV

      - name: Compilar Bin√°rio
        run: |
          BIN_NAME="totp-${{ matrix.os }}-${{ matrix.arch }}"
          if [ "${{ matrix.os }}" = "windows" ]; then BIN_NAME="${BIN_NAME}.exe"; fi
          GOOS=${{ matrix.os }} GOARCH=${{ matrix.arch }} go build -ldflags "-X 'github.com/JVitoroliv3ira/termotp/internal/version.Version=${VERSION}'" -o $BIN_NAME

      - name: Criar Artefatos
        uses: actions/upload-artifact@v4
        with:
          name: totp-${{ matrix.os }}-${{ matrix.arch }}
          path: totp-${{ matrix.os }}-${{ matrix.arch }}*

  release:
    name: Criar Release no GitHub
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout c√≥digo-fonte
        uses: actions/checkout@v4

      - name: Obter Artefatos dos Builds
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Criar Release com Instru√ß√µes de Instala√ß√£o
        uses: softprops/action-gh-release@v2
        with:
          body: |
            # üöÄ TermOTP - Vers√£o ${{ github.ref_name }}

            **TermOTP** √© uma ferramenta CLI para gerenciar c√≥digos TOTP de autentica√ß√£o em dois fatores (**2FA**) com seguran√ßa e criptografia.

            ## üì• Instala√ß√£o
            
            ### üîπ **Linux**
            ```sh
            sudo rm -f /usr/local/bin/totp
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/totp-linux-amd64 -O totp
            chmod +x totp
            sudo mv totp /usr/local/bin/
            ```
            ‚úÖ **Agora voc√™ pode rodar `totp` de qualquer lugar no terminal!**

            ### üîπ **Windows**
            Abra o **PowerShell como Administrador** e execute:  
            ```powershell
            Remove-Item "C:\Program Files\TermOTP\totp.exe" -ErrorAction SilentlyContinue
            mkdir "C:\Program Files\TermOTP" -ErrorAction SilentlyContinue
            Invoke-WebRequest -Uri "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/totp-windows-amd64.exe" -OutFile "C:\Program Files\TermOTP\totp.exe"
            [System.Environment]::SetEnvironmentVariable("Path", $Env:Path + ";C:\Program Files\TermOTP", [System.EnvironmentVariableTarget]::Machine)
            ```
            ‚úÖ **Agora reinicie o terminal e rode `totp` de qualquer lugar!**

            ## üöÄ Como Usar
            ```sh
            totp --help
            ```

            ### üìÇ Gerenciamento de Contas
            ```sh
            totp account add -n gitlab
            totp account delete -n google
            ```

            ### üî¢ Gerenciamento de C√≥digos
            ```sh
            totp code generate -n github
            totp code copy -n github
            totp code list
            ```

            ### üì¶ Outros Comandos
            ```sh
            totp version
            ```

            üìñ Para mais detalhes sobre um comando espec√≠fico, use:  
            ```sh
            totp <comando> --help
            ```
            Exemplo:
            ```sh
            totp account --help
            ```

            Para um guia completo, acesse a **[documenta√ß√£o oficial](https://github.com/JVitoroliv3ira/termotp/wiki)**.

            üîπ *Se curtiu, deixa uma ‚≠ê no reposit√≥rio!*
          files: artifacts/**
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
